trigger:
  branches:
    include:
      - develop

pr:
  branches:
    include:
      - develop

stages:
  - stage: SecurityScans
    displayName: "Security Scans on PR"
    jobs:
      - job: GitleaksScan
        displayName: "Run Gitleaks Secret Scan"
        pool:
          vmImage: ubuntu-latest

        steps:
          - checkout: self
            fetchDepth: '0'

          - script: |
              echo "Installing Gitleaks..."
              curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz -o gitleaks.tar.gz
              tar -xzf gitleaks.tar.gz
              sudo mv gitleaks /usr/local/bin/
              echo "Running Gitleaks..."
              gitleaks detect --source . --report-path gitleaks-report.json --exit-code 1
            displayName: "Run Gitleaks Scan"
            continueOnError: 'true'   # âœ… Allow pipeline to continue even if secrets are found

          - task: PublishBuildArtifacts@1
            displayName: "Upload Gitleaks Report"
            inputs:
              PathtoPublish: gitleaks-report.json
              ArtifactName: gitleaks-report
              publishLocation: Container

      - job: TrivyScan
        displayName: "Run Trivy Filesystem Scan"
        dependsOn: GitleaksScan
        pool:
          vmImage: ubuntu-latest

        steps:
          - checkout: self

          - script: |
              echo "Installing Trivy..."
              sudo apt-get update
              sudo apt-get install -y wget
              wget https://github.com/aquasecurity/trivy/releases/download/v0.51.1/trivy_0.51.1_Linux-64bit.tar.gz
              tar -zxvf trivy_0.51.1_Linux-64bit.tar.gz
              sudo mv trivy /usr/local/bin/
            displayName: "Install Trivy"

          - script: |
              echo "Running Trivy filesystem scan..."
              trivy fs . --format table --output trivy-report.txt || true
            displayName: "Run Trivy Filesystem Scan"

          - task: PublishBuildArtifacts@1
            displayName: "Upload Trivy Report"
            inputs:
              PathtoPublish: trivy-report.txt
              ArtifactName: trivy-report
              publishLocation: Container
